class BabylonScene{constructor(e){const{id:t,name:i,game:s}=e;this.id=t,this.name=i,this.game=s,this.scene=new BABYLON.Scene(s.engine),this.keyInputMap={},this.keyCodeInputMap={},this.sounds={},this.gameObjects={},this.selectedGameObject=null,this.assetsManager=null,this.game.isPlayMode()&&(this.timer={startedTime:0,duration:0,pausedTime:0,isRunning:!1},setSceneApiFunctions(this))}render(){this.scene&&this.scene.activeCamera&&this.scene.render()}dispose(){this.scene.dispose()}static create(e){const{game:t,data:i}=e,{id:s,name:n,soundIds:a,gameObjectIds:r,gameObjects:o}=i,d=new BabylonScene({id:s,name:n,game:t}),c=d.game.isPlayMode();d.game.isEditMode()&&(d.setEditorCamera(i.editorCamera),d.setGizmoLayers(),d.setPointerPicker()),c&&(d.setPhysicsEngine(),d.setActionManager()),d.setGUI(),d.addFirstRenderObserver();const h=new BABYLON.AssetsManager(d.scene);if(d.game.isPreviewMode()&&(h.useDefaultLoadingScreen=!1),d.assetsManager=h,c&&a&&a.length>0){const e=d.game.getSoundAssets();a.forEach((t=>{BabylonSound.create({scene:d,data:e[t]})}))}else d.allSoundsAdded=!0;return r&&r.length>0?r.forEach((e=>{const t=o[e];BabylonGameObject.create({scene:d,data:t,oncreate:e=>{d.addGameObject(e),d.checkAllGameObjectAdded()}})})):d.allGameObjectsAdded=!0,d.assetsManager._tasks.length>0?d.loadAssetsManager():d.checkAllAssetsAdded(),null}addMeshTask(e,t,i,s){return this.assetsManager.addMeshTask(e,t,i,s)}addBinaryFileTask(e,t){return this.assetsManager.addBinaryFileTask(e,t)}loadAssetsManager(e){0!==this.assetsManager._tasks.length&&(this.assetsManager.onFinish=()=>{this.assetsManager.reset(),e&&e()},this.assetsManager.load())}runAllUserScript(){if(0!==this.getGameObjectCount())for(const e in this.gameObjects)this.gameObjects[e].runUserScript()}addFirstRenderObserver(){this.onAfterRenderObserver=this.scene.onAfterRenderObservable.add(this.onAfterFirstRender.bind(this))}onAfterFirstRender(){this.updateAllGUITransforms(),this.scene.onAfterRenderObservable.remove(this.onAfterRenderObserver)}addBeforeRenderObservable(e){return this.scene.onBeforeRenderObservable.add(e)}removeBeforeRenderObservable(e){return this.scene.onBeforeRenderObservable.remove(e)}updateAllGUITransforms(){for(let e in this.gameObjects){const t=this.gameObjects[e];t instanceof BabylonGui&&t.updateGUIProperties()}}addSound(e){this.checkSoundValid(e)||e.dispose(),this.sounds[e.name]=e,this.getSoundCount()===this.game.getSceneData(this.id).soundIds.length&&this.onAllSoundsAdded()}addGameObject(e){this.checkGameObjectValid(e)?(this.gameObjects[e.id]=e,e instanceof BabylonGui&&this.addGUI(e)):e.dispose()}removeGameObject(e){e in this.gameObjects&&(this.getGameObject(e).dispose(),delete this.gameObjects[e])}getSound(e){return e in this.sounds?this.sounds[e]:null}getGameObject(e){return e in this.gameObjects?this.gameObjects[e]:null}getFirstGameObjectWithName(e){if(0===this.getGameObjectCount())return null;for(const t in this.gameObjects)if(this.gameObjects[t].name===e)return this.gameObjects[t];return null}getGameObjectsWithName(e){if(0===this.getGameObjectCount())return null;let t;t=Array.isArray(e)?e:[e];const i=[];for(const e in this.gameObjects)t.includes(this.gameObjects[e].name)&&i.push(this.gameObjects[e]);return i}getSoundCount(){return Object.keys(this.sounds).length}getGameObjectCount(){return Object.keys(this.gameObjects).length}checkSoundValid(e){return!(!e.id||""===e.id)&&!this.getSound(e.name)}checkGameObjectValid(e){return!(!e.id||""===e.id)&&!this.getGameObject(e.id)}setSoundVolume(e){let t=e;t<0?t=0:t>1&&(t=1),BABYLON.Engine.audioEngine.setGlobalVolume(t)}getSoundVolume(){return BABYLON.Engine.audioEngine.getGlobalVolume()}setEditorCamera(e){const{target:t={x:0,y:0,z:0},position:i={x:10,y:5,z:-10}}=e||{},s=new BABYLON.UniversalCamera("EditorCamera",new BABYLON.Vector3(i.x,i.y,i.z),this.scene);s.speed=.6,s.setTarget(new BABYLON.Vector3(t.x,t.y,t.z)),s.attachControl(this.game.canvas,!0),this.scene.activeCamera=s,this.editorCamera=s,this.scene.onAfterRenderObservable.add(this.watchEditorCameraTransformChange.bind(this))}setEditorCameraFocus(e){if(!this.editorCamera)return void(this.editorCameraFocus=e);const t=this.getGameObject(e);if(t){const e=t.gameObject.position;if(!e)return;const i=BABYLON.Vector3.Distance(e,this.editorCamera.position);if(BabylonConstant.EDITOR_CAMERA_FOCUS_DISTANCE!==i){const t=BabylonConstant.EDITOR_CAMERA_FOCUS_DISTANCE/i,s=BABYLON.Vector3.Lerp(e,this.editorCamera.position,t);this.editorCamera.position=s}this.editorCamera.setTarget(e)}}watchEditorCameraTransformChange(){this.editorCamera&&(this.checkEditorCameraTransformChanged()&&(this.onChangeEditorCameraTransfomTimeout&&(clearTimeout(this.onChangeEditorCameraTransfomTimeout),this.onChangeEditorCameraTransfomTimeout=void 0),this.onChangeEditorCameraTransfomTimeout=setTimeout(this.onChangeEditorCameraTransform.bind(this),500)),this.prevEditorCameraPosition=this.editorCamera.position.clone(),this.prevEditorCameraTarget=this.editorCamera.target.clone())}checkEditorCameraTransformChanged(){return!(this.editorCamera.position.equals(this.prevEditorCameraPosition)&&this.editorCamera.target.equals(this.prevEditorCameraTarget))}onChangeEditorCameraTransform(){const e={sceneId:this.id,position:{x:this.trimFloat(this.editorCamera.position.x),y:this.trimFloat(this.editorCamera.position.y),z:this.trimFloat(this.editorCamera.position.z)},target:{x:this.trimFloat(this.editorCamera.target.x),y:this.trimFloat(this.editorCamera.target.y),z:this.trimFloat(this.editorCamera.target.z)}};this.game.triggerListener("editorCameraTransformChange",e)}trimFloat(e){return parseFloat(parseFloat(e).toFixed(5))}setGizmoLayers(){this.gizmoLayer=new BABYLON.UtilityLayerRenderer(this.scene)}setPointerPicker(){this.scene.onPointerDown=function(){this.pointerPickedObject=this.getPointerPickedGameObject()}.bind(this),this.scene.onPointerUp=function(){const e=this.getPointerPickedGameObject();e===this.pointerPickedObject&&this.onPointerPickGameObject(e)}.bind(this)}getPointerPickedGameObject(){const e=this.createPickingRay(),t=this.scene.pickWithRay(e);return t.pickedMesh?this.getGameObject(t.pickedMesh.id):null}createPickingRay(){return this.scene.createPickingRay(this.scene.pointerX,this.scene.pointerY,BABYLON.Matrix.Identity(),this.scene.activeCamera)}onPointerPickGameObject(e){this.game.triggerListener("gameObjectSelect",{sceneId:this.id,gameObjectId:e?e.id:null})}selectGameObjectWithId(e){const t=this.getGameObject(e);t&&this.selectGameObject(t)}selectGameObject(e){this.selectedGameObject!==e&&(this.selectedGameObject&&(this.deselectGameObject(this.selectedGameObject),this.selectedGameObject=null),e&&(this.selectedGameObject=e,e.onSelected(),e instanceof BabylonGui?this.showGUIEditor():this.hideGUIEditor()))}deselectGameObject(e){e.onDeselected()}setPhysicsEngine(){const e=new BABYLON.CannonJSPlugin,t=new BABYLON.Vector3(0,-10,0);this.scene.enablePhysics(t,e)}getPhysicsEngine(){return this.scene.getPhysicsEngine()}isPhysicsEnabled(){return!!this.getPhysicsEngine()}setActionManager(){const e=new BABYLON.ActionManager(this.scene);e.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger,(e=>{this.keyInputMap[e.sourceEvent.key]="keydown"==e.sourceEvent.type,this.keyCodeInputMap[e.sourceEvent.keyCode]="keydown"==e.sourceEvent.type}))),e.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger,(e=>{this.keyInputMap[e.sourceEvent.key]="keydown"==e.sourceEvent.type,this.keyCodeInputMap[e.sourceEvent.keyCode]="keydown"==e.sourceEvent.type}))),this.scene.actionManager=e}getActionManager(){return this.scene.actionManager}setGUI(){const e=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("FullscreenUI",!0);this.scene.advancedTexture=e,this.game.isEditMode()&&this.setGUIEditor()}addGUI(e){this.game.isEditMode()?this.guiContainer.addControl(e.gameObject):this.scene.advancedTexture.addControl(e.gameObject)}removeGUI(e){this.game.isEditMode()?this.guiContainer.removeControl(e.gameObject):this.scene.advancedTexture.removeControl(e.gameObject)}setGUIEditor(){const e=new BABYLON.GUI.Container("guiEditorContainer");e.width=1,e.height=1,this.scene.advancedTexture.addControl(e),this.guiEditorContainer=e;const t=new BABYLON.GUI.Rectangle("guiContainerVisibleRect");t.width=.6,t.fixedRatio=9/16,t.color="white",t.thickness=3,t.cornerRadius=12,t.clipContent=!1,t.shadowColor="black",e.addControl(t),this.guiContainerVisibleRect=t;const i=new BABYLON.GUI.TextBlock("guiContainerVisibleTitle");i.top="12px",i.left="12px",i.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,i.textVerticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,i.text="GUI",i.fontSize=18,i.color="white",t.addControl(i),this.guiContainerVisibleTitle=i;const s=new BABYLON.GUI.Container("guiContainer");s.width=.6,s.fixedRatio=9/16,s.clipContent=!0,e.addControl(s),this.guiContainer=s,this.hideGUIEditor()}getGUISizeInPixels(){return{width:this.game.isEditMode()?this.guiContainer.widthInPixels:this.game.engine.getRenderWidth(),height:this.game.isEditMode()?9*this.guiContainer.widthInPixels/16:this.game.engine.getRenderHeight()}}showGUIEditor(){this.game.isEditMode()&&(this.guiContainerVisibleRect.isVisible=!0,this.guiContainerVisibleTitle.isVisible=!0)}hideGUIEditor(){this.game.isEditMode()&&(this.guiContainerVisibleRect.isVisible=!1,this.guiContainerVisibleTitle.isVisible=!1)}onChangeCurrentGizmoType(e){this.selectedGameObject&&this.selectedGameObject.onChangeCurrentGizmoType(e)}onAllSoundsAdded(){this.allSoundsAdded=!0,this.checkAllAssetsAdded()}checkAllGameObjectAdded(){this.getGameObjectCount()===this.game.getSceneData(this.id).gameObjectIds.length&&this.onAllGameObjectsAdded()}onAllGameObjectsAdded(){for(let e in this.gameObjects){this.gameObjects[e].onAllGameObjectsAdded()}this.editorCameraFocus&&(this.editorCameraFocus=null,this.setEditorCameraFocus(this.editorCameraFocus)),this.allGameObjectsAdded=!0,this.checkAllAssetsAdded()}checkAllAssetsAdded(){this.allSoundsAdded&&this.allGameObjectsAdded&&(this.assetsManager._tasks.length>0&&(this.assetsManager.onFinish(),this.assetsManager.onFinish=null),this.game.onSceneLoaded(this),this.allSoundsAdded=void 0,this.allGameObjectsAdded=void 0)}getLightObject(){for(let e in this.gameObjects){const t=this.gameObjects[e];if(t instanceof BabylonLight)return t}}startTimer(){this.timer.isRunning=!0,this.timer.startedTime=(new Date).getTime()}pauseTimer(){this.timer.pausedTime=(new Date).getTime(),this.timer.isRunning=!1}resumeTimer(){this.timer.isRunning||(this.timer.startedTime+=(new Date).getTime()-this.timer.pausedTime,this.timer.isRunning=!0)}resetTimer(){this.timer.isRunning=!1,this.timer.duration=0}getTimer(){return this.timer.isRunning&&(this.timer.duration=(new Date).getTime()-this.timer.startedTime,this.timer.duration/=1e3,this.timer.duration=this.timer.duration.toFixed(1)),parseFloat(this.timer.duration)}}window.BabylonScene=BabylonScene;